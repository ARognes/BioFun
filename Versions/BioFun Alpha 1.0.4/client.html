<!DOCTYPE html>
<html>
	<header>
		<title>BioFun</title>
		<h2>BioFun</h2>
	</header>
	<body>	
		<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
		<div id='container'>
			<canvas id='canvas1' height='480px' width='640px'> Your browser does not support the HTML5 canvas tag</canvas>
			<div id='mainMenu'>
				<input type='submit' id='submit' onclick='submit ()' value='Play'/>
				<input type='text' id='textBox' onkeypress='if (event.keyCode == 13) submit ()' placeholder='Nickname'/>
			</div>
			<div id='playMenu' display='none'>
				<input type='button' id='online' onclick='online ()' value='Online'/>
				<input type='button' id='direct' onclick='direct ()' value='Direct'/>
				<input type='button' id='multiplayer' onclick='multiplayer ()' value='2-Player'/>
			</div>
			<div id='readyMenu' display='none'>
				<input type='button' id='ready' onclick='ready ()' value='Ready'>
			</div>
			<div id='controls' display='none'>
				<input type='button' id='rage' onclick='submitRage ()' value='Rage'>
			</div>
		</div>
		<style>
			
			#container {
				width: 640px;
				height: 480px;
				display: inline-block;
				margin: 0 auto;
				background: #5555FF;
				position: relative;
				border: 2px solid black;
				border-radius: 10px;
				box-shadow: 0 5px 50px #333;
			}
			#canvas1 {
				z-index: 1;
				position: relative;
			}
			#mainMenu {
				z-index: 2;
				position: relative;
			}
			#playMenu {
				z-index: 2;
				position: relative;
			}
			#readyMenu {
				z-index: 2;
				position: relative;
			}
			#controls {
				z-index: 2;
				position: relative;
			}
			#submit {
				bottom: 200px;
				left: 280px;
				width: 80px;
				height: 30px;
				position: absolute;
			}
			#textBox {
				bottom: 240px;
				left: 240px;
				width: 160px;
				text-align: center;
				position: absolute;
			}
			#online {
				bottom: 280px;
				left: 260px;
				width: 120px;
				height: 30px;
				position: absolute;
			}
			#direct {
				bottom: 240px;
				left: 260px;
				width: 120px;
				height: 30px;
				position: absolute;
			}
			#multiplayer {
				bottom: 200px;
				left: 260px;
				width: 120px;
				height: 30px;
				position: absolute;
			}
			#ready {
				bottom: 240px;
				left: 260px;
				width: 120px;
				height: 30px;
				position: absolute;
			}
			#rage {
				bottom: 440px;
				left: 290px;
				width: 120px;
				height: 30px;
				position: absolute;
			}
			
		</style>
		<script>
		
//IMAGES
var empty = document.createElement ("img");
empty.src = "Tile.png";
var select = document.createElement ("img");
select.src = "Selected.png";
var check = document.createElement ("img");
check.src = "Check.png";
var white1 = document.createElement ("img");
white1.src = "White 1.png";
var white2 = document.createElement ("img");
white2.src = "White 2.png";
var white3 = document.createElement ("img");
white3.src = "White 3.png";
var white4 = document.createElement ("img");
white4.src = "White 4.png";
var red1 = document.createElement ("img");
red1.src = "Red 1.png";
var red2 = document.createElement ("img");
red2.src = "Red 2.png";
var red3 = document.createElement ("img");
red3.src = "Red 3.png";
var red4 = document.createElement ("img");
red4.src = "Red 4.png";
var point1 = document.createElement ("img");
point1.src = "Point 1.png";
var point2 = document.createElement ("img");
point2.src = "Point 2.png";
var point3 = document.createElement ("img");
point3.src = "Point 3.png";
	
var c = document.getElementById("canvas1");
var ctx = c.getContext("2d");
var server = io.connect ('http://192.168.1.116:8080/');
//Moms '192.168.1.116'
//Dads '70.58.137.160'
var size = 20;
var mouseX = 0;
var mouseY = 0;
var tile = [];
var points = 0;
var nickname;
var enemyNickname;
var team;
var room;
var stage = 0;
var startTile;
var totSize;
var rage;
var lastTime = Date.now (),
    timeSincePoint = 0;

//CONTROLS
function submitRage () {
	if (rage >= 16) {
		server.emit ('rage', room, team);
	}
}
	
//MAIN MENU
function submit () {
	stage = 1;
	nickname = document.getElementById ('textBox').value;
	if (!nickname) nickname = 'Rebel';
	server.emit ('new user', nickname);
}

function online () {
	server.emit ('findRoom', nickname);
}

function direct () {

}

function multiplayer () {

}

//PRESSED THE READY BUTTON
function ready () {
	if (stage == 3) {
		if (startTile > -1) server.emit ('ready', room, team, startTile, nickname);
	}
}
//RECEIVED POINTS AND TILES
server.on ('tiles', function (updatedTiles, pointsTeam, newPoints, newRage, terrainPoint) {
	if (pointsTeam == team) {
		if (Math.round (newPoints-0.5) > Math.round (points-0.5) && terrainPoint == false) timeSincePoint = 0;
		points = newPoints;
		rage = newRage;
	}
	tile = updatedTiles;
	//CALCULATE OPEN TILES
	for (lu=0; lu<tile.length; lu++) {if (tile [lu] == 1 || tile [lu] == -1) tile [lu] = 0;}
	for (l=0; l<tile.length; l++) {
		//LEFT RIGHT
		var lr = 0;
		for (left=0; left<400; left+= 20) {if (l == left) lr = 1;}
		for (right=-1; right<=399; right+= 20) {if (l == right) lr = 2;}
		if (team == 0) {
			if (tile [l] < -1) {
				if (tile [l-1] == 0 && lr != 1) tile [l-1] = -1;
				if (tile [l+1] == 0 && lr != 2) tile [l+1] = -1;
				if (tile [l-20] == 0) tile [l-20] = -1;
				if (tile [l+20] == 0) tile [l+20] = -1;
				if (tile [l] < -2) {
					if (tile [l-19] == 0 && lr != 2) tile [l-19] = -1;
					if (tile [l+19] == 0 && lr != 1) tile [l+19] = -1;
					if (tile [l-21] == 0 && lr != 1) tile [l-21] = -1;
					if (tile [l+21] == 0 && lr != 2) tile [l+21] = -1;
				}
			}
		}
		else if (team == 1) {
			if (tile [l] > 1) {
				if (tile [l-1] == 0 && tile [l] < 10 && lr != 1) tile [l-1] = 1;
				if (tile [l+1] == 0 && tile [l] < 10 && lr != 2) tile [l+1] = 1;
				if (tile [l-20] == 0 && tile [l] < 10) tile [l-20] = 1;
				if (tile [l+20] == 0 && tile [l] < 10) tile [l+20] = 1;
				if (tile [l] > 2) {
					if (tile [l-19] == 0 && tile [l] < 10 && lr != 2) tile [l-19] = 1;
					if (tile [l+19] == 0 && tile [l] < 10 && lr != 1) tile [l+19] = 1;
					if (tile [l-21] == 0 && tile [l] < 10 && lr != 1) tile [l-21] = 1;
					if (tile [l+21] == 0 && tile [l] < 10 && lr != 2) tile [l+21] = 1;
				}
			}
		}
	}
});
//RECEIVED POINTS
server.on ('points', function (p1, p2) {
	if (team == 0) {
		if (Math.round (points-0.5) < Math.round (p1-0.5)) timeSincePoint = 0;
		points = p1;
	}
	else if (team == 1) {
		if (Math.round (points-0.5) < Math.round (p2-0.5)) timeSincePoint = 0;
		points = p2;
	}
});
//PRESSED THE ONLINE BUTTON AND GOT A ROOM
server.on ('joinRoom', function (newRoom, newTeam) {
	room = newRoom;
	team = newTeam;
	timeSincePoint = 1.0;
	rage = 0;
	points = 16;
	stage = 2;
});
//ROOM IS FULL
server.on ('roomReady', function (selectTiles, name1, name2) {
	stage = 3;
	tile = selectTiles;
	for (la=0; la<tile.length; la++) {
		if (team == 0 && tile [la] == 1) tile [la] = 0;
		else if (team == 1 && tile [la] == -1)  tile [la] = 0;
	}
	if (team == 0) enemyNickname = name2;
	else enemyNickname = name1;
});
//ENSURE READY MESSAGE WENT THROUGH
server.on ('readied', function () {
	if (stage == 3) stage = 4;
});
//START GAME
server.on ('start', function () {
	stage = 5;
});
//GAME OVER
server.on ('gameOver', function (winner) {
	console.log (team);
	if (winner == 5) {
		if (team == 0) stage = 6;
		else stage = 7;
	}
	if (winner == 6) {
		if (team == 1) stage = 6;
		else stage = 7;
	}
	//ROOM RECYCLED
	if (winner == 0) stage = 0;
});

function updateTiles () {
	var pSize = 0;
	var canvasSquare = 400/size;
	var push = [120, canvasSquare*3.5];
	var tileNum = -1;
	if (stage >= 3) {
		for (var y = 0; y < size; y++) {
			for (var x = 0; x < size; x++) {
				tileNum++;
				//MOUSE
				var inBox;
				var tNum;
				if (mouseX < x*canvasSquare+canvasSquare+push [0] && mouseX >= x*canvasSquare+push [0] && mouseY < y*canvasSquare+canvasSquare+push [1] && mouseY >= y*canvasSquare+push [1]) {
					inBox = true;
					tNum = tileNum;
					if (stage >= 3) ctx.drawImage (select, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
				}
				//RENDER
				if (tile [tileNum] == 0) ctx.drawImage (empty, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
				else {
					if (tile [tileNum] == 10) ctx.drawImage (point1, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
					else if (tile [tileNum] == 11) ctx.drawImage (point2, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
					else if (tile [tileNum] == 12) ctx.drawImage (point3, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
					else {
						if (team == 0) {
							if (tile [tileNum] < 0) {
								if (tile [tileNum] != -1) pSize++;
								if (tile [tileNum] == -1) ctx.drawImage (check, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == -2) ctx.drawImage (white1, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == -3) ctx.drawImage (white2, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == -4) ctx.drawImage (white3, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == -5) ctx.drawImage (white4, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							}
							if (tile [tileNum] == 2) ctx.drawImage (red1, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							if (tile [tileNum] == 3) ctx.drawImage (red2, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							if (tile [tileNum] == 4) ctx.drawImage (red3, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							if (tile [tileNum] == 5) ctx.drawImage (red4, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
						}
						else if (team == 1) {
							if (tile [tileNum] > 0 && tile [tileNum] < 10) {
								if (tile [tileNum] != 1) pSize++;
								if (tile [tileNum] == 1) ctx.drawImage (check, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == 2) ctx.drawImage (white1, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == 3) ctx.drawImage (white2, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == 4) ctx.drawImage (white3, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
								if (tile [tileNum] == 5) ctx.drawImage (white4, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							}
							if (tile [tileNum] == -2) ctx.drawImage (red1, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							if (tile [tileNum] == -3) ctx.drawImage (red2, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							if (tile [tileNum] == -4) ctx.drawImage (red3, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
							if (tile [tileNum] == -5) ctx.drawImage (red4, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
						}
					}
					document.onmousedown = function (mouse) {
						if (inBox) {
							//LEFT RIGHT
							var lr2 = 0;
							for (left2=0; left2<400; left2 += 20) {if (tNum == left2) lr2 = 1;}
							for (right2=-1; right2<=399; right2 += 20) {if (tNum == right2) lr2 = 2;}
							if (team == 0) {
								if (tile [tNum] < 0) {
									server.emit ('select', tNum, room, team);
									if (stage == 3) startTile = tNum;
								}
								else {
									var touching = 0;
									if (tile [tNum-1] < -1 && lr2 != 1) touching++;
									if (tile [tNum+1] < -1 && lr2 != 2) touching++;
									if (tile [tNum-20] < -1) touching++;
									if (tile [tNum+20] < -1) touching++;
									if (tile [tNum-19] < -2 && lr2 != 2) touching++;
									if (tile [tNum+19] < -2 && lr2 != 1) touching++;
									if (tile [tNum-21] < -2 && lr2 != 1) touching++;
									if (tile [tNum+21] < -2 && lr2 != 2) touching++;
									if (touching > 0) server.emit ('select', tNum, room, team);
								}
							}
							else if (team == 1) {
								if (tile [tNum] > 0 && tile [tNum] < 10) {
									server.emit ('select', tNum, room, team);
									if (stage == 3) startTile = tNum;
								}
								else {
									var touching2 = 0;
									if (tile [tNum-1] > 1 && tile [tNum-1] < 10 && lr2 != 1) touching2++;
									if (tile [tNum+1] > 1 && tile [tNum+1] < 10 && lr2 != 2) touching2++;
									if (tile [tNum-20] > 1 && tile [tNum-20] < 10) touching2++;
									if (tile [tNum+20] > 1 && tile [tNum+20] < 10) touching2++;
									if (tile [tNum-19] > 2 && tile [tNum-19] < 10 && lr2 != 2) touching2++;
									if (tile [tNum+19] > 2 && tile [tNum+19] < 10 && lr2 != 1) touching2++;
									if (tile [tNum-21] > 2 && tile [tNum-21] < 10 && lr2 != 1) touching2++;
									if (tile [tNum+21] > 2 && tile [tNum+21] < 10 && lr2 != 2) touching2++;
									if (touching2 > 0) server.emit ('select', tNum, room, team);
								}
							}
						}
					}
					//START TILE
					if (stage == 3 && startTile > -1 || stage == 4 && startTile > -1) {
						if (tileNum == startTile) ctx.drawImage (white4, x*canvasSquare+push [0], y*canvasSquare+push [1], canvasSquare, canvasSquare);
					}
				}
			}
		}
	}
	//SEARCHING IMAGE
	if (stage == 2) ctx.drawImage (select, canvas1.width/2-canvasSquare*2, canvas1.height/2-canvasSquare*2, canvasSquare*4, canvasSquare*4);
	totSize = pSize;
}

function update () {
	ctx.clearRect (0, 0, canvas1.width, canvas1.height);
	//TIME
	var now = Date.now ();
	var frameRate = now - lastTime;
	//FPS
	ctx.font = '10px Arial';
	ctx.fillStyle = 'black';
	ctx.fillText ('fps: '+Math.round(1000/frameRate), 35, 100);
	lastTime = now;
	//SHOW MENUS
	if (stage == 0) document.getElementById ('mainMenu').style.display = 'block';
	else document.getElementById ('mainMenu').style.display = 'none';
	if (stage == 1) document.getElementById ('playMenu').style.display = 'block';
	else document.getElementById ('playMenu').style.display = 'none';
	if (stage == 3) document.getElementById ('readyMenu').style.display = 'block';
	else document.getElementById ('readyMenu').style.display = 'none';
	if (stage < 6 && stage > 2) document.getElementById ('controls').style.display = 'block';
	else document.getElementById ('controls').style.display = 'none';
	//if (stage == 5 || stage == 6) document.getElementById ('gameOverMenu').style.display = 'block';
	//else document.getElementById ('gameOverMenu').style.display = 'none';
	//DRAW UNDERNEATH TILES
	ctx.fillStyle = '#000000';
	ctx.fillRect (110, 60, 420, 420);
	ctx.fillStyle = '#7777FF';
	ctx.fillRect (120, 70, 400, 400);
	updateTiles ();
	ctx.font = '50px Arial';
	ctx.fillStyle = 'red';
	ctx.textAlign = 'center';
	//POINTS SCOREBOARD
	if (stage < 6 && stage > 2) {
		var displayPoints = Math.round (points-0.5);
		if (displayPoints < 0) displayPoints = 0;
		ctx.fillText (displayPoints, 160, 48);
		//POINT BAR
		ctx.fillStyle = '#9dd1bb';
		ctx.fillRect (220, 34, 300, 14);
		ctx.fillStyle = '#005215';
		timeSincePoint += frameRate/2000+totSize/12000;
		if (timeSincePoint > 1.0) timeSincePoint = 1;
		ctx.fillRect (220, 34, timeSincePoint*300, 14);
		//RAGE BAR
		ctx.fillStyle = '#9dd1bb';
		ctx.fillRect (220, 10, 300, 14);
		ctx.fillStyle = '#005215';
		if (rage > 16.0) rage = 16;
		if (rage == 16) document.getElementById ('rage').style.display = 'block';
		else document.getElementById ('rage').style.display = 'none';
		ctx.fillRect (220, 10, (rage/16)*300, 14);
	}
	else {
		if (stage == 7) ctx.fillText ('YOU SUCK!', canvas1.width/2, 240);
		else ctx.fillText ('WINNER!', canvas1.width/2, 240);
	}
	//Nicknames
	if (stage == 5) {
		ctx.font = "20px Arial";
		ctx.fillText (nickname, 60, 30);
		ctx.fillText (enemyNickname, 420, 30);
	}
}

document.onmousemove = function (mouse) {
	mouseX = mouse.clientX-container.offsetLeft+window.pageXOffset;
	mouseY = mouse.clientY-container.offsetTop+window.pageYOffset;
}

setInterval (update, 1);
		</script>
	</body>
</html>